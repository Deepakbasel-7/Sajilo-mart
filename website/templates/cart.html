{% extends 'base.html' %}

{% block title %} Cart {% endblock %}

{% block body %}

<div class="container my-5">
    <div class="row">
        {% if cart %}
        <h1 class="text-center mb-5" style="color: white;">Shopping Cart</h1>

        <!-- Cart Items -->
        <div class="col-sm-8">
            <div class="card">
                <div class="card-body">

                    {% for item in cart %}
                    <div class="row mb-4">
                        <div class="col-sm-3 text-center align-self-center">
                            <img src="{{ item.product.product_picture }}" alt="" class="img-fluid img-thumbnail shadow-sm" height="150px" width="150px">
                        </div>
                        <div class="col-sm-9">
                            <div>
                                <h4>{{ item.product.product_name }}</h4>
                                <div class="my-3">
                                    <label>Quantity</label>
                                    <a class="minus-cart btn" pid="{{ item.id }}"><i class="fas fa-minus-square fa-lg"></i></a>
                                    <span id="quantity{{ item.id }}">{{ item.quantity }}</span>
                                    <a class="plus-cart btn" pid="{{ item.id }}"><i class="fas fa-plus-square fa-lg"></i></a>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="mb-0"><strong>Rs {{ item.product.current_price }}</strong></p>
                                    <a href="#" class="remove-cart btn btn-sm btn-secondary mr-3" pid="{{ item.id }}">Remove</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    {% endfor %}

                </div>
            </div>
        </div>

        <!-- Cart Summary -->
        <div class="col-sm-4">
            <div class="card">
                <div class="card-body">
                    <h3>Cart Summary</h3>
                    <hr>
                    <ul class="list-group">

                        {% for item in cart %}
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                            <strong>{{ item.product.product_name }}</strong>
                            <span>{{ item.product.current_price }} × <span id="quantitySummary{{ item.id }}">{{ item.quantity }}</span></span>
                        </li>
                        {% endfor %}

                        <li class="list-group-item d-flex justify-content-between border-0 px-0 pb-0">
                            <strong>Amount</strong>
                            <span>Rs <span id="amount_tt">{{ amount }}</span></span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between border-0 px-0 mb-3">
                            <div>
                                <strong>Total</strong>
                                <small>(Including Shipping)</small>
                            </div>
                            <span>Rs <strong id="totalamount">{{ total }}</strong></span>
                        </li>

                    </ul>

                    <!-- Khalti Button -->
                    <div class="d-grid mt-3">
                        <button id="khalti-payment-button" class="btn btn-success">Pay with Khalti</button>
                    </div>

                </div>
            </div>
        </div>

        {% else %}
        <h1 class="text-center mb-5" style="color: white;">Your Cart is Empty</h1>
        {% endif %}
    </div>
</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Khalti Script -->
<script src="https://khalti.com/static/khalti-checkout.js"></script>

<script>
    const khaltiAmount = Number("{{ total | default(0) | int }}") * 100;

    var config = {
        publicKey: "test_public_key_xxxxxxxxxxxxxxxxxxxxxxxx",  // ✅ Replace with your Khalti public key
        productIdentity: "cart_{{ current_user.id }}",
        productName: "E-Commerce Order",
        productUrl: "{{ request.url }}",
        paymentPreference: ["KHALTI", "EBANKING", "MOBILE_BANKING", "CONNECT_IPS"],

        eventHandler: {
            onSuccess(payload) {
                fetch("/verify-khalti", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        token: payload.token,
                        amount: khaltiAmount
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = "/orders";
                    } else {
                        alert("Payment verification failed.");
                    }
                });
            },
            onError(error) {
                console.error("Khalti Error:", error);
            },
            onClose() {
                console.log("Khalti widget closed");
            }
        }
    };

    var checkout = new KhaltiCheckout(config);
    document.getElementById("khalti-payment-button").onclick = function () {
        checkout.show({ amount: khaltiAmount });
    };
</script>

{% endblock %}
